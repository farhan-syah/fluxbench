//! GitHub Summary Output
//!
//! Generates Markdown tables for $GITHUB_STEP_SUMMARY.

use crate::report::{BenchmarkStatus, Report, ReportSummary};
use fluxbench_logic::{VerificationResult, VerificationStatus};

/// Generate GitHub-compatible Markdown summary
pub fn generate_github_summary(report: &Report) -> String {
    let mut output = String::with_capacity(8192);

    // Header
    output.push_str("## FluxBench Results\n\n");
    output.push_str(&format!(
        "**Commit:** `{}` | **Branch:** `{}` | **Date:** {}\n\n",
        report.meta.git_commit.as_deref().unwrap_or("unknown"),
        report.meta.git_branch.as_deref().unwrap_or("unknown"),
        report.meta.timestamp.format("%Y-%m-%d %H:%M UTC"),
    ));

    // Summary table
    write_summary_table(&mut output, &report.summary);

    // Critical benchmarks
    write_critical_benchmarks(&mut output, report);

    // Verifications
    write_verifications(&mut output, &report.verifications);

    // Footer
    output.push_str("\n---\n");
    output.push_str(&format!(
        "*Generated by FluxBench v{}*\n",
        env!("CARGO_PKG_VERSION")
    ));

    output
}

fn write_summary_table(output: &mut String, summary: &ReportSummary) {
    output.push_str("### Summary\n\n");
    output.push_str("| Status | Count |\n");
    output.push_str("|--------|-------|\n");
    output.push_str(&format!("| Passed | {} |\n", summary.passed));
    output.push_str(&format!("| Failed | {} |\n", summary.failed));
    output.push_str(&format!("| Crashed | {} |\n", summary.crashed));
    output.push_str(&format!("| Skipped | {} |\n", summary.skipped));
    output.push_str(&format!("| Regressions | {} |\n", summary.regressions));
    output.push_str(&format!("| Improvements | {} |\n", summary.improvements));
    output.push('\n');
}

fn write_critical_benchmarks(output: &mut String, report: &Report) {
    let critical: Vec<_> = report
        .results
        .iter()
        .filter(|r| {
            r.status != BenchmarkStatus::Passed
                || r.comparison
                    .as_ref()
                    .map(|c| c.relative_change > 5.0)
                    .unwrap_or(false)
        })
        .collect();

    if critical.is_empty() {
        return;
    }

    output.push_str("### Critical Benchmarks\n\n");
    output.push_str("| Benchmark | Mean | p99 | Change | Status |\n");
    output.push_str("|-----------|------|-----|--------|--------|\n");

    for result in critical.iter().take(10) {
        let mean = result
            .metrics
            .as_ref()
            .map(|m| format_duration(m.mean_ns))
            .unwrap_or_else(|| "-".to_string());
        let p99 = result
            .metrics
            .as_ref()
            .map(|m| format_duration(m.p99_ns))
            .unwrap_or_else(|| "-".to_string());
        let change = result
            .comparison
            .as_ref()
            .map(|c| format_change(c.relative_change))
            .unwrap_or_else(|| "-".to_string());
        let status = format!("{:?}", result.status).to_lowercase();

        output.push_str(&format!(
            "| `{}` | {} | {} | {} | {} |\n",
            result.id, mean, p99, change, status
        ));
    }
    output.push('\n');
}

fn write_verifications(output: &mut String, verifications: &[VerificationResult]) {
    if verifications.is_empty() {
        return;
    }

    output.push_str("### Verifications\n\n");
    output.push_str("| Check | Expression | Result |\n");
    output.push_str("|-------|------------|--------|\n");

    for v in verifications {
        let icon = match &v.status {
            VerificationStatus::Passed => "PASS",
            VerificationStatus::Failed => "FAIL",
            VerificationStatus::Skipped { .. } => "SKIP",
            VerificationStatus::Error { .. } => "ERR",
        };

        let result = match &v.status {
            VerificationStatus::Passed | VerificationStatus::Failed => v
                .actual_value
                .map(|val| format!("{:.2}", val))
                .unwrap_or_default(),
            VerificationStatus::Skipped { missing_metrics } => {
                format!("skipped: {} unavailable", missing_metrics)
            }
            VerificationStatus::Error { message } => {
                format!("error: {}", message)
            }
        };

        output.push_str(&format!(
            "| {} {} | `{}` | {} |\n",
            icon, v.id, v.expression, result
        ));
    }
    output.push('\n');
}

fn format_duration(ns: f64) -> String {
    if ns < 1_000.0 {
        format!("{:.0} ns", ns)
    } else if ns < 1_000_000.0 {
        format!("{:.1} us", ns / 1_000.0)
    } else if ns < 1_000_000_000.0 {
        format!("{:.2} ms", ns / 1_000_000.0)
    } else {
        format!("{:.2} s", ns / 1_000_000_000.0)
    }
}

fn format_change(pct: f64) -> String {
    if pct.abs() < 1.0 {
        "stable".to_string()
    } else if pct < 0.0 {
        format!("{:.1}%", pct)
    } else {
        format!("+{:.1}%", pct)
    }
}
